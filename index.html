<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pain Med Sync</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <link rel="icon" type="image/png" sizes="192x192" href="icon.png">

    <style>
        :root {
            --ibu-color: #e57373;
            --aceta-color: #64b5f6;
            --bg-color: #121212;
            --text-color: #ffffff;
            --card-bg: #1e1e1e;
            --danger-color: #ff5252;
            --warning-color: #ffab40;
            --sync-color: #4caf50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        /* Status Section */
        #status-panel {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Sync Indicator */
        #sync-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #555; /* Gray = Unknown */
        }
        .status-online { background-color: var(--sync-color) !important; box-shadow: 0 0 8px var(--sync-color); }
        .status-offline { background-color: var(--danger-color) !important; }
        .status-syncing { background-color: var(--warning-color) !important; animation: blink 1s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }

        h1 { margin: 0 0 5px 0; font-size: 1rem; opacity: 0.8; }
        
        #next-dose-time {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 5px 0;
            color: #4caf50;
        }
        
        .wait-text { color: #ff9800 !important; }
        #recommendation { font-size: 1.1rem; font-weight: 500; }

        /* Daily Totals Section */
        #daily-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
        }

        .stat-val { font-size: 1.1rem; font-weight: bold; display: block; margin-top: 4px; }
        .stat-ibu { color: var(--ibu-color); }
        .stat-aceta { color: var(--aceta-color); }
        .safe { opacity: 1; }
        .warning { color: var(--warning-color); }
        .danger { color: var(--danger-color); }

        /* Buttons Section */
        .button-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            border: none;
            border-radius: 12px;
            padding: 25px 5px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            line-height: 1.4;
        }
        button:active { transform: scale(0.96); }

        #btn-ibu { background-color: var(--ibu-color); }
        #btn-aceta { background-color: var(--aceta-color); }

        /* Log Section */
        .log-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        #btn-undo {
            background-color: transparent;
            color: #999;
            padding: 5px 10px;
            font-size: 0.9rem;
            border: 1px solid #444;
            box-shadow: none;
        }

        #log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #333;
            font-size: 1rem;
        }
        
        .pending-item { opacity: 0.5; font-style: italic; } /* Visual style for offline logs */

        .log-med { font-weight: bold; }
        .log-ibu { color: var(--ibu-color); }
        .log-aceta { color: var(--aceta-color); }
        .log-time { color: #aaa; }
        .refresh-hint { text-align: center; color: #555; font-size: 0.8rem; margin-top: 10px; }

    </style>
</head>
<body>

    <div id="status-panel">
        <div id="sync-badge" title="Status"></div>
        <h1 id="status-title">Loading...</h1>
        <div id="next-dose-time">--:--</div>
        <div id="recommendation">Checking history...</div>
    </div>

    <div id="daily-stats">
        <div class="stat-card">
            <span>Daily Ibuprofen</span>
            <span class="stat-val stat-ibu" id="daily-ibu-val">0 / 3200 mg</span>
        </div>
        <div class="stat-card">
            <span>Daily Acetamin.</span>
            <span class="stat-val stat-aceta" id="daily-aceta-val">0 / 4000 mg</span>
        </div>
    </div>

    <div class="button-container">
        <button id="btn-ibu" onclick="queueAction('add', 'Ibuprofen')">Ibuprofen<br>(600mg)</button>
        <button id="btn-aceta" onclick="queueAction('add', 'Acetaminophen')">Acetaminophen<br>(1000mg)</button>
    </div>

    <div class="log-header-container">
        <span>History</span>
        <button id="btn-undo" onclick="queueAction('undo')">Undo Last</button>
    </div>

    <ul id="log-list"></ul>
    <div class="refresh-hint" id="sync-text">Loading...</div>

    <script>
        // --- PASTE YOUR GOOGLE SCRIPT URL HERE ---
        const SCRIPT_URL = 'PASTE_YOUR_URL_HERE'; 
        // ------------------------------------------

        const DOSE_IBU = 600;
        const DOSE_ACETA = 1000;
        const LIMIT_IBU = 3200; 
        const LIMIT_ACETA = 4000;

        // State
        let logs = []; // The authoritative list
        let queue = []; // Offline actions waiting to sync
        let isSyncing = false;

        function init() {
            // 1. Load from LocalStorage immediately (Instant load)
            const cachedLogs = localStorage.getItem('pain_logs');
            const cachedQueue = localStorage.getItem('pain_queue');
            
            if (cachedLogs) logs = JSON.parse(cachedLogs);
            if (cachedQueue) queue = JSON.parse(cachedQueue);
            
            render();
            updateSyncStatus('offline'); // Assume offline until proven otherwise

            // 2. Start Sync Loops
            // Try to pull fresh data every 60s
            setInterval(fetchData, 60000); 
            // Try to push queue items every 5s
            setInterval(processQueue, 5000); 
            // Update timers every 10s
            setInterval(updateStatus, 10000); 

            // 3. Initial Fetch
            fetchData();
        }

        // --- CORE LOGIC: Optimistic UI ---

        function queueAction(action, med = '') {
            const timestamp = Date.now();
            
            // Create a temporary object for the queue
            const item = { action, med, timestamp };
            
            // 1. Update UI Immediately (Optimistic)
            if (action === 'add') {
                // Add to front of logs locally so user sees it instantly
                logs.unshift({ med, time: timestamp, pending: true }); 
            } else if (action === 'undo') {
                // Remove first item locally
                logs.shift();
            }

            // 2. Add to Queue
            queue.push(item);
            saveLocal();
            render();

            // 3. Trigger immediate sync attempt
            processQueue(); 
        }

        // --- SYNC LOGIC ---

        function processQueue() {
            if (queue.length === 0 || isSyncing) return;
            if (!navigator.onLine) {
                updateSyncStatus('offline');
                return;
            }

            isSyncing = true;
            updateSyncStatus('syncing');

            // Take the oldest item from the queue (FIFO)
            const item = queue[0];
            
            // Construct URL with timestamp
            const url = `${SCRIPT_URL}?action=${item.action}&med=${item.med}&passedTime=${item.timestamp}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Success! Remove item from queue
                    queue.shift(); 
                    saveLocal();

                    // If queue is now empty, we can trust the server data
                    if (queue.length === 0) {
                        logs = data; 
                        saveLocal();
                        render();
                        updateSyncStatus('online');
                    } else {
                        // If more items, trigger next process immediately
                        processQueue();
                    }
                })
                .catch(error => {
                    console.error('Sync failed:', error);
                    updateSyncStatus('offline');
                })
                .finally(() => {
                    isSyncing = false;
                });
        }

        function fetchData() {
            if (!navigator.onLine) return;
            // Only fetch if queue is empty (otherwise we might overwrite local pending changes)
            if (queue.length > 0) return;

            fetch(`${SCRIPT_URL}?action=read`)
                .then(response => response.json())
                .then(data => {
                    logs = data;
                    saveLocal();
                    render();
                    updateSyncStatus('online');
                })
                .catch(() => updateSyncStatus('offline'));
        }

        // --- HELPERS ---

        function saveLocal() {
            localStorage.setItem('pain_logs', JSON.stringify(logs));
            localStorage.setItem('pain_queue', JSON.stringify(queue));
        }

        function updateSyncStatus(status) {
            const badge = document.getElementById('sync-badge');
            const text = document.getElementById('sync-text');
            
            if (status === 'online') {
                badge.className = 'status-online';
                text.innerText = 'Synced with Google Sheets';
            } else if (status === 'syncing') {
                badge.className = 'status-syncing';
                text.innerText = 'Syncing...';
            } else {
                badge.className = 'status-offline';
                text.innerText = 'Offline Mode (Data saved to device)';
            }
        }

        function isToday(timestamp) {
            const date = new Date(Number(timestamp));
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function formatTime(timestamp) {
            const date = new Date(Number(timestamp));
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDay(timestamp) {
            if (isToday(timestamp)) return "Today";
            const date = new Date(Number(timestamp));
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function render() {
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            
            let dailyIbuCount = 0;
            let dailyAcetaCount = 0;

            // 1. Render List & Calculate Totals
            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'log-item';
                if (log.pending) li.classList.add('pending-item'); // Gray out pending items

                const medClass = log.med === 'Ibuprofen' ? 'log-ibu' : 'log-aceta';
                const statusIcon = log.pending ? ' (saving...)' : '';
                
                li.innerHTML = `
                    <span class="log-med ${medClass}">${log.med}${statusIcon}</span>
                    <span class="log-time">${formatDay(log.time)} ${formatTime(log.time)}</span>
                `;
                list.appendChild(li);

                if (isToday(log.time)) {
                    if (log.med === 'Ibuprofen') dailyIbuCount++;
                    if (log.med === 'Acetaminophen') dailyAcetaCount++;
                }
            });

            // 2. Update Daily Stats UI
            updateStat('daily-ibu-val', dailyIbuCount * DOSE_IBU, LIMIT_IBU);
            updateStat('daily-aceta-val', dailyAcetaCount * DOSE_ACETA, LIMIT_ACETA);

            // 3. Update Timer Logic
            updateStatus();
        }

        function updateStat(elementId, current, limit) {
            const el = document.getElementById(elementId);
            el.innerText = `${current} / ${limit} mg`;
            el.className = 'stat-val'; // reset
            
            if (current >= limit) el.classList.add('danger');
            else if (current >= (limit * 0.75)) el.classList.add('warning');
            else {
                if (elementId.includes('ibu')) el.classList.add('stat-ibu');
                if (elementId.includes('aceta')) el.classList.add('stat-aceta');
            }
        }

        function updateStatus() {
            const statusTitle = document.getElementById('status-title');
            const nextTimeDisplay = document.getElementById('next-dose-time');
            const recDisplay = document.getElementById('recommendation');

            if (logs.length === 0) {
                statusTitle.innerText = "No doses logged";
                nextTimeDisplay.innerText = "NOW";
                nextTimeDisplay.classList.remove('wait-text');
                recDisplay.innerText = "Start with either medication";
                return;
            }

            const lastLog = logs[0];
            const lastTime = Number(lastLog.time);
            const nextTime = lastTime + (3 * 60 * 60 * 1000); 
            const now = Date.now();
            const nextMed = lastLog.med === 'Ibuprofen' ? 'Acetaminophen' : 'Ibuprofen';

            if (now >= nextTime) {
                statusTitle.innerText = "You are eligible for:";
                nextTimeDisplay.innerText = "NOW";
                nextTimeDisplay.classList.remove('wait-text');
                recDisplay.innerHTML = `Take <strong>${nextMed}</strong>`;
            } else {
                statusTitle.innerText = "Next dose eligible at:";
                nextTimeDisplay.innerText = formatTime(nextTime);
                nextTimeDisplay.classList.add('wait-text');
                
                const diffMins = Math.ceil((nextTime - now) / 60000);
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                
                recDisplay.innerHTML = `Wait ${hours}h ${mins}m for <strong>${nextMed}</strong>`;
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        init();
    </script>
</body>
</html>
