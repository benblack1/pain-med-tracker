<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pain Med Sync</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <link rel="icon" type="image/png" sizes="192x192" href="icon.png">

    <style>
        :root {
            --ibu-color: #e57373;
            --aceta-color: #64b5f6;
            --bg-color: #121212;
            --text-color: #ffffff;
            --card-bg: #1e1e1e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        /* Loading Overlay */
        #loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Status Section */
        #status-panel {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        h1 { margin: 0 0 10px 0; font-size: 1.2rem; opacity: 0.8; }
        
        #next-dose-time {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            color: #4caf50;
        }
        
        .wait-text { color: #ff9800 !important; }

        #recommendation { font-size: 1.1rem; font-weight: 500; }

        /* Buttons Section */
        .button-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            border: none;
            border-radius: 12px;
            padding: 30px 10px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        button:disabled { opacity: 0.5; }

        #btn-ibu { background-color: var(--ibu-color); }
        #btn-aceta { background-color: var(--aceta-color); }

        /* Log Section */
        .log-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        #btn-undo {
            background-color: transparent;
            color: #999;
            padding: 5px 10px;
            font-size: 0.9rem;
            border: 1px solid #444;
            box-shadow: none;
        }

        #log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #333;
            font-size: 1rem;
        }

        .log-med { font-weight: bold; }
        .log-ibu { color: var(--ibu-color); }
        .log-aceta { color: var(--aceta-color); }
        .log-time { color: #aaa; }
        .refresh-hint { text-align: center; color: #555; font-size: 0.8rem; margin-top: 10px; }

    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="status-panel">
        <h1 id="status-title">Loading...</h1>
        <div id="next-dose-time">--:--</div>
        <div id="recommendation">Checking history...</div>
    </div>

    <div class="button-container">
        <button id="btn-ibu" onclick="sendAction('add', 'Ibuprofen')">Ibuprofen<br>(600mg)</button>
        <button id="btn-aceta" onclick="sendAction('add', 'Acetaminophen')">Acetaminophen<br>(600mg)</button>
    </div>

    <div class="log-header-container">
        <span>History</span>
        <button id="btn-undo" onclick="sendAction('undo')">Undo Last</button>
    </div>

    <ul id="log-list"></ul>
    <div class="refresh-hint">Data pulls from Google Sheets</div>

    <script>
        // PASTE YOUR GOOGLE WEB APP URL HERE
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzPMUbqEbgPnCjnmwjcs-p7CZk0N4zSm9xYjVRPugQqDqIHVMgtIv2rsPCNxEZdmO8Q2Q/exec'; 

        let logs = [];

        function showLoader(show) {
            document.getElementById('loader').style.visibility = show ? 'visible' : 'hidden';
        }

        function init() {
            fetchData();
            // Auto-refresh every 60 seconds
            setInterval(fetchData, 60000);
            // Update the timer countdown every 10 seconds (no network call needed)
            setInterval(updateStatus, 10000);
        }

        function fetchData() {
            // "read" isn't a specific action in the script, 
            // but calling the URL without parameters returns the list anyway.
            // We use 'read' just to be explicit if we expand later.
            const url = `${SCRIPT_URL}?action=read`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    logs = data;
                    render();
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('status-title').innerText = "Connection Error";
                });
        }

        function sendAction(action, med = '') {
            showLoader(true);
            // We use standard GET requests for simplicity to avoid CORS preflight issues 
            // on some browsers with simple scripts.
            const url = `${SCRIPT_URL}?action=${action}&med=${med}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    logs = data; // The script returns the updated list
                    render();
                    showLoader(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showLoader(false);
                    alert("Failed to sync. Check internet.");
                });
        }

        function formatTime(timestamp) {
            const date = new Date(Number(timestamp));
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDay(timestamp) {
            const date = new Date(Number(timestamp));
            const today = new Date();
            if (date.getDate() === today.getDate()) return "Today";
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function render() {
            const list = document.getElementById('log-list');
            list.innerHTML = '';

            // 1. Render List
            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'log-item';
                const medClass = log.med === 'Ibuprofen' ? 'log-ibu' : 'log-aceta';
                
                li.innerHTML = `
                    <span class="log-med ${medClass}">${log.med}</span>
                    <span class="log-time">${formatDay(log.time)} ${formatTime(log.time)}</span>
                `;
                list.appendChild(li);
            });

            // 2. Update Status Logic
            updateStatus();
        }

        function updateStatus() {
            const statusTitle = document.getElementById('status-title');
            const nextTimeDisplay = document.getElementById('next-dose-time');
            const recDisplay = document.getElementById('recommendation');

            if (logs.length === 0) {
                statusTitle.innerText = "No doses logged";
                nextTimeDisplay.innerText = "NOW";
                nextTimeDisplay.classList.remove('wait-text');
                recDisplay.innerText = "Start with either medication";
                return;
            }

            const lastLog = logs[0];
            const lastTime = Number(lastLog.time);
            const nextTime = lastTime + (3 * 60 * 60 * 1000); // 3 hours
            const now = Date.now();

            const nextMed = lastLog.med === 'Ibuprofen' ? 'Acetaminophen' : 'Ibuprofen';

            if (now >= nextTime) {
                statusTitle.innerText = "You are eligible for:";
                nextTimeDisplay.innerText = "NOW";
                nextTimeDisplay.classList.remove('wait-text');
                recDisplay.innerHTML = `Take <strong>${nextMed}</strong>`;
            } else {
                statusTitle.innerText = "Next dose eligible at:";
                nextTimeDisplay.innerText = formatTime(nextTime);
                nextTimeDisplay.classList.add('wait-text');
                
                const diffMins = Math.ceil((nextTime - now) / 60000);
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                
                recDisplay.innerHTML = `Wait ${hours}h ${mins}m for <strong>${nextMed}</strong>`;
            }
        }

        init();
    </script>
</body>
</html>
